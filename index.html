<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Sites Management Tool</title>

    <style>
        :root {
            --bg-color: rgba(0, 0, 0, 0.55);
            --text-color: #eee;
            --link-color: #ffd966;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            position: relative;
            color: var(--text-color);
        }

        .menu-row {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            position: relative;
        }

        .menu-box {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 14px;
            background: var(--bg-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            flex: 1;
        }

        .menu-box h3 {
            margin: 0 0 8px 0;
            font-size: 15px;
        }

        input,
        select {
            height: 32px;
            padding: 4px 8px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .search-row {
            margin-top: 10px;
            display: flex;
            gap: 6px;
        }

        .search-row input {
            flex: 1;
        }

        .fav-bar {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 16px;
            background: var(--bg-color);
        }

        .fav-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            margin: 4px;
            border-radius: 20px;
            background: #ffe9a8;
            border: 1px solid #e0c36a;
            cursor: grab;
            font-size: 14px;
        }

        body[style*="--bg-color: rgba(0, 0, 0, 0.55)"] .fav-item {
            background: #333;
            border-color: #555;
        }

        .fav-item a {
            text-decoration: none;
            color: #333 !important;
            font-weight: bold;
        }

        body[style*="--bg-color: rgba(0, 0, 0, 0.55)"] .fav-item a {
            color: #ffd966 !important;
        }

        .fav-item a:hover {
            text-decoration: underline;
        }

        .main {
            display: flex;
            gap: 18px;
            position: relative;
        }

        .group-panel {
            width: 220px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            background: var(--bg-color);
        }

        .group-item {
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 6px;
            border: 1px solid transparent;
        }

        .group-item:hover {
            background: rgba(224, 223, 221, 0.35);
            color: #ffd966;
        }

        .group-item.active {
            background: rgba(224, 223, 221, 0.35);
            border-color: #ffd966;
            color: #ffd966;
            font-weight: bold;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }

        .site-panel {
            flex: 1;
        }

        .site {
            padding: 8px;
            border: 1px solid #aaa;
            margin: 6px 0;
            background: var(--bg-color);
            border-radius: 6px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .site.drag-over {
            border: 2px dashed #000;
            background: #eef3ff;
        }

        .site a {
            color: var(--link-color);
            text-decoration: none;
        }

        .site a:hover {
            text-decoration: underline;
        }

        .site-url {
            color: #666;
            font-size: 13px;
            max-width: 420px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .group-title-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        button {
            margin-left: 4px;
            cursor: pointer;
        }

        #currentGroupTitle {
            color: #000000;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }
    </style>
</head>

<body>

    <div class="menu-row">
        <div class="menu-box">
            <h3>üíæ ÏÇ¨Ïù¥Ìä∏ Î∞±ÏóÖ / Í≤ÄÏÉâ</h3>
            <button onclick="backupData()">Î∞±ÏóÖ</button>
            <button onclick="restoreClick()">Î≥µÏõê</button>
            <button onclick="bgFile.click()">Î∞∞Í≤Ω</button>
            <button onclick="resetBg()" style="color:red;">Î∞∞Í≤ΩÏÇ≠Ï†ú</button>
            <button onclick="toggleTheme()">üåó Îã§ÌÅ¨/ÎùºÏù¥Ìä∏ ÌÜ†Í∏Ä</button>
            <input type="file" id="restoreFile" hidden accept=".json">
            <input type="file" id="bgFile" hidden accept="image/*">

            <div class="search-row">
                <input id="searchInput" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•" onkeydown="if(event.key==='Enter') searchGoogle()">
                <button onclick="searchGoogle()">Íµ¨Í∏Ä</button>
                <button onclick="searchNaver()">ÎÑ§Ïù¥Î≤Ñ</button>
            </div>
        </div>

        <div class="menu-box">
            <h3>üìÅ Í∑∏Î£π ÏÉùÏÑ±</h3>
            <input id="newGroupInput">
            <button onclick="addGroup()">ÏÉùÏÑ±</button>
        </div>

        <div class="menu-box">
            <h3>‚ûï ÏÇ¨Ïù¥Ìä∏ / Ìè¥Îçî Ï∂îÍ∞Ä</h3>
            <input id="nameInput" placeholder="Ïù¥Î¶Ñ"><br>
            <input id="urlInput" placeholder="URL ÎòêÎäî Ìè¥Îçî" style="margin-top:4px;"><br>
            <select id="groupSelect" style="margin-top:4px;"></select>
            <button onclick="addSite()">Ï∂îÍ∞Ä</button>
        </div>
    </div>

    <div class="fav-bar">
        <b>‚≠ê Ï¶êÍ≤®Ï∞æÍ∏∞</b>
        <div id="favBar"></div>
    </div>

    <div class="main">
        <div class="group-panel" id="groupPanel"></div>
        <div class="site-panel">
            <div class="group-title-bar">
                <h3 id="currentGroupTitle"></h3>
                <button onclick="renameGroup()">Ïù¥Î¶ÑÏàòÏ†ï</button>
                <button onclick="deleteGroup()">ÏÇ≠Ï†ú</button>
            </div>
            <div id="siteList"></div>
        </div>
    </div>

    <script>
        // --- IndexedDB Î°úÏßÅ Ï∂îÍ∞Ä ---
        const DB_NAME = "SiteManagerDB";
        const STORE_NAME = "Assets";
        let db;

        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore(STORE_NAME);
        };
        request.onsuccess = e => {
            db = e.target.result;
            loadData(); // DB Ïó∞Í≤∞ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        };

        function saveBgToDB(base64) {
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put(base64, "backgroundImage");
        }

        function loadBgFromDB(callback) {
            const tx = db.transaction(STORE_NAME, "readonly");
            const req = tx.objectStore(STORE_NAME).get("backgroundImage");
            req.onsuccess = () => callback(req.result);
        }

        function deleteBgFromDB() {
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).delete("backgroundImage");
        }
        // -------------------------

        let groups = [];
        let sites = [];
        let favorites = [];
        let selectedGroup = null;
        let editIndex = null;
        let dragSiteIndex = null;
        let dragGroupIndex = null;
        let dragFavIndex = null;
        let darkMode = true;

        const favBar = document.getElementById('favBar');
        const groupPanel = document.getElementById('groupPanel');
        const siteList = document.getElementById('siteList');
        const currentGroupTitle = document.getElementById('currentGroupTitle');
        const groupSelect = document.getElementById('groupSelect');
        const searchInput = document.getElementById('searchInput');
        const newGroupInput = document.getElementById('newGroupInput');
        const nameInput = document.getElementById('nameInput');
        const urlInput = document.getElementById('urlInput');
        const restoreFile = document.getElementById('restoreFile');
        const bgFile = document.getElementById('bgFile');

        function getSearchText() { return encodeURIComponent(searchInput.value.trim()); }
        function searchGoogle() { const q = getSearchText(); if (!q) return; window.open("https://www.google.com/search?q=" + q, "_blank"); }
        function searchNaver() { const q = getSearchText(); if (!q) return; window.open("https://search.naver.com/search.naver?query=" + q, "_blank"); }

        bgFile.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const bgImg = ev.target.result;
                applyBg(bgImg);
                saveBgToDB(bgImg); // IndexedDBÏóê ÎåÄÏö©Îüâ Ï†ÄÏû•
            };
            reader.readAsDataURL(file);
        });

        function applyBg(url) { document.body.style.backgroundImage = url ? `url('${url}')` : "none"; }
        function resetBg() { if (confirm("Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ≠Ï†úÌï†ÍπåÏöî?")) { applyBg(""); deleteBgFromDB(); } }

        function normalizeUrl(input) {
            if (!input) return "";
            input = input.trim();
            if (/^(https?:\/\/|file:\/\/)/i.test(input)) return input;
            if (/^[a-zA-Z]:[\\/]/.test(input)) return "file:///" + input.replace(/\\/g, "/");
            if (/^\\\\/.test(input)) return "file:" + input.replace(/\\/g, "/");
            if (input.includes(".")) return "https://" + input;
            return input;
        }
        function getIcon(url) { return url.startsWith("file://") ? "üìÅ" : "üåê"; }

        function saveData() { 
            // Î∞∞Í≤ΩÏù¥ÎØ∏ÏßÄÎäî Ï†úÏô∏ÌïòÍ≥† LocalStorageÏóê Ï†ÄÏû•
            localStorage.setItem("siteData", JSON.stringify({ groups, sites, favorites, darkMode })); 
        }

        function loadData() {
            const d = JSON.parse(localStorage.getItem("siteData"));
            if (d) { 
                groups = d.groups || []; 
                sites = d.sites || []; 
                favorites = d.favorites || []; 
                darkMode = d.darkMode !== false; 
                applyTheme(); 
            }
            // Î∞∞Í≤ΩÏù¥ÎØ∏ÏßÄÎäî IndexedDBÏóêÏÑú ÎπÑÎèôÍ∏∞Î°ú Í∞ÄÏ†∏Ïò¥
            loadBgFromDB(img => {
                if (img) applyBg(img);
                renderAll();
            });
        }

        async function backupData() { 
            loadBgFromDB(bgImg => {
                const blob = new Blob([JSON.stringify({ groups, sites, favorites, bgImg, darkMode }, null, 2)], { type: "application/json" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "sites_backup.json";
                a.click();
            });
        }

        function restoreClick() { restoreFile.click(); }
        restoreFile.addEventListener("change", e => {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
                const d = JSON.parse(ev.target.result);
                groups = d.groups || []; 
                sites = d.sites || []; 
                favorites = d.favorites || []; 
                darkMode = d.darkMode !== false;
                
                if (d.bgImg) {
                    applyBg(d.bgImg);
                    saveBgToDB(d.bgImg);
                } else {
                    applyBg("");
                    deleteBgFromDB();
                }
                
                applyTheme(); 
                saveData(); 
                renderAll();
            };
            r.readAsText(f);
        });

        function addGroup() { const n = newGroupInput.value.trim(); if (!n || groups.includes(n)) return; groups.push(n); newGroupInput.value = ""; saveData(); renderAll(); }
        function renameGroup() { if (!selectedGroup) return; const n = prompt("ÏÉà Ïù¥Î¶Ñ", selectedGroup); if (!n || groups.includes(n)) return; groups = groups.map(g => g === selectedGroup ? n : g); sites.forEach(s => { if (s.group === selectedGroup) s.group = n; }); selectedGroup = n; saveData(); renderAll(); }
        function deleteGroup() { if (!selectedGroup) return; if (!confirm("Í∑∏Î£π ÏÇ≠Ï†ú?")) return; groups = groups.filter(g => g !== selectedGroup); sites.filter(s => s.group === selectedGroup).forEach(s => { const idx = sites.indexOf(s); favorites = favorites.filter(f => f !== idx); }); sites = sites.filter(s => s.group !== selectedGroup); selectedGroup = groups[0] || null; saveData(); renderAll(); }

        function addSite() { const name = nameInput.value.trim(); let url = urlInput.value.trim(); const group = groupSelect.value; if (!name || !url) return; url = normalizeUrl(url); if (editIndex !== null) { sites[editIndex] = { name, url, group }; editIndex = null; } else { sites.push({ name, url, group }); } nameInput.value = ""; urlInput.value = ""; saveData(); renderSites(); renderFavorites(); }
        function editSite(i) { nameInput.value = sites[i].name; urlInput.value = sites[i].url; groupSelect.value = sites[i].group; editIndex = i; }
        function deleteSite(i) { if (!confirm("ÏÇ≠Ï†ú?")) return; sites.splice(i, 1); favorites = favorites.filter(x => x !== i).map(x => x > i ? x - 1 : x); saveData(); renderAll(); }

        function toggleFavorite(i) { if (favorites.includes(i)) favorites = favorites.filter(x => x !== i); else favorites.push(i); saveData(); renderFavorites(); renderSites(); }
        function renderFavorites() {
            favBar.innerHTML = "";
            favorites.forEach((idx, pos) => {
                const s = sites[idx]; if (!s) return;
                const d = document.createElement("div"); d.className = "fav-item"; d.draggable = true;
                d.ondragstart = () => dragFavIndex = pos;
                d.ondragover = e => e.preventDefault();
                d.ondrop = e => { if (dragFavIndex === null) return; const mv = favorites.splice(dragFavIndex, 1)[0]; favorites.splice(pos, 0, mv); dragFavIndex = null; saveData(); renderFavorites(); };
                d.innerHTML = `${getIcon(s.url)} <a href="${s.url}" target="_blank">${s.name}</a> <button onclick="toggleFavorite(${idx})">‚ùå</button>`;
                favBar.appendChild(d);
            });
        }

        function renderGroupPanel() {
            groupPanel.innerHTML = "";
            groups.forEach((g, idx) => {
                const div = document.createElement("div");
                div.className = "group-item" + (g === selectedGroup ? " active" : "");
                div.textContent = g;
                div.draggable = true;
                div.onclick = () => { selectedGroup = g; renderAll(); };
                div.ondragover = e => e.preventDefault();
                div.ondrop = e => {
                    if (dragSiteIndex !== null) { sites[dragSiteIndex].group = g; dragSiteIndex = null; saveData(); renderAll(); }
                    if (dragGroupIndex !== null) { const d = groups.splice(dragGroupIndex, 1)[0]; groups.splice(idx, 0, d); dragGroupIndex = null; saveData(); renderAll(); }
                };
                div.ondragstart = () => dragGroupIndex = idx;
                groupPanel.appendChild(div);
            });
        }

        function renderSites() {
            currentGroupTitle.textContent = "üìÅ " + (selectedGroup || "");
            siteList.innerHTML = "";
            sites.forEach((s, i) => {
                if (s.group !== selectedGroup) return;
                const div = document.createElement("div"); div.className = "site"; div.draggable = true;
                div.ondragstart = () => dragSiteIndex = i;
                div.ondragover = e => { e.preventDefault(); div.classList.add("drag-over"); };
                div.ondragleave = () => div.classList.remove("drag-over");
                div.ondrop = e => {
                    e.stopPropagation();
                    div.classList.remove("drag-over");
                    if (dragSiteIndex === null || dragSiteIndex === i) return;
                    const moved = sites.splice(dragSiteIndex, 1)[0];
                    sites.splice(i, 0, moved);
                    favorites = favorites.map(idx => { if (idx === dragSiteIndex) return i; if (dragSiteIndex < i && idx > dragSiteIndex && idx <= i) return idx - 1; if (dragSiteIndex > i && idx < i && idx >= i) return idx + 1; return idx; });
                    dragSiteIndex = null;
                    saveData();
                    renderSites();
                    renderFavorites();
                };
                const favMark = favorites.includes(i) ? "‚≠ê" : "‚òÜ";
                div.innerHTML = `${getIcon(s.url)} <a href="${s.url}" target="_blank">${s.name}</a> <a class="site-url" href="${s.url}" target="_blank">${s.url}</a> <button onclick="toggleFavorite(${i})">${favMark}</button> <button onclick="editSite(${i})">ÏàòÏ†ï</button> <button onclick="deleteSite(${i})">ÏÇ≠Ï†ú</button>`;
                siteList.appendChild(div);
            });
        }

        function renderGroupOptions() {
            groupSelect.innerHTML = "";
            groups.forEach(g => { const o = document.createElement("option"); o.value = g; o.textContent = g; groupSelect.appendChild(o); });
        }

        function renderAll() { 
            if (groups.length === 0) groups.push("Í∏∞Î≥∏");
            if (!selectedGroup) selectedGroup = groups[0]; 
            renderGroupOptions(); 
            renderGroupPanel(); 
            renderSites(); 
            renderFavorites(); 
        }

        function toggleTheme() {
            darkMode = !darkMode;
            applyTheme();
            saveData();
        }
        function applyTheme() {
            if (darkMode) {
                document.documentElement.style.setProperty("--bg-color", "rgba(0,0,0,0.55)");
                document.documentElement.style.setProperty("--text-color", "#eee");
                document.documentElement.style.setProperty("--link-color", "#ffd966");
            } else {
                document.documentElement.style.setProperty("--bg-color", "rgba(245,247,250,0.55)");
                document.documentElement.style.setProperty("--text-color", "#111");
                document.documentElement.style.setProperty("--link-color", "#053bc5");
            }
        }
    </script>

    <script>
        document.addEventListener('contextmenu', e => e.preventDefault(), false);
        document.addEventListener('selectstart', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey) {
                const target = e.target.tagName;
                if ((target === 'INPUT' || target === 'TEXTAREA') && e.keyCode == 65) return true; 
                if (e.keyCode == 'U'.charCodeAt(0) || 
                    e.keyCode == 'S'.charCodeAt(0) || 
                    (e.shiftKey && e.keyCode == 'I'.charCodeAt(0))) {
                    return false;
                }
            }
        };
    </script>

</body>
</html>